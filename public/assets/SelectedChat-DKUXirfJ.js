import{a7 as oe,a8 as le,a9 as de,r as g,aa as ue,j as i,k as ge,ab as fe,ac as me,l as he,d as xe,f as je,i as Me,F as v,x as R,ad as F,I as W,J as ye,K as I,ae as pe,af as we,E as x,O as k,ag as Se,M as D,S as be,T,ah as $e,ai as _,aj as Ce,ak as K,$ as Ie,a0 as X,al as A,a3 as C,am as ke,an as Ge,Q as Ee,a5 as Y,ao as Ne,ap as Pe,aq as Te,ar as Ae,as as Re,at as ze,au as Le,av as Be,aw as De,ax as _e}from"./index-CWabRAkK.js";import{g as Oe}from"./functions-BhBJ70XI.js";const ve=(e,n)=>e.filter(t=>n.includes(t)),$=(e,n,t)=>{const s=e.keys[0];Array.isArray(n)?n.forEach((c,a)=>{t((o,l)=>{a<=e.keys.length-1&&(a===0?Object.assign(o,l):o[e.up(e.keys[a])]=l)},c)}):n&&typeof n=="object"?(Object.keys(n).length>e.keys.length?e.keys:ve(e.keys,Object.keys(n))).forEach(a=>{if(e.keys.includes(a)){const o=n[a];o!==void 0&&t((l,w)=>{s===a?Object.assign(l,w):l[e.up(a)]=w},o)}}):(typeof n=="number"||typeof n=="string")&&t((c,a)=>{Object.assign(c,a)},n)};function G(e){return`--Grid-${e}Spacing`}function E(e){return`--Grid-parent-${e}Spacing`}const O="--Grid-columns",b="--Grid-parent-columns",Fe=({theme:e,ownerState:n})=>{const t={};return $(e.breakpoints,n.size,(s,c)=>{let a={};c==="grow"&&(a={flexBasis:0,flexGrow:1,maxWidth:"100%"}),c==="auto"&&(a={flexBasis:"auto",flexGrow:0,flexShrink:0,maxWidth:"none",width:"auto"}),typeof c=="number"&&(a={flexGrow:0,flexBasis:"auto",width:`calc(100% * ${c} / var(${b}) - (var(${b}) - ${c}) * (var(${E("column")}) / var(${b})))`}),s(t,a)}),t},We=({theme:e,ownerState:n})=>{const t={};return $(e.breakpoints,n.offset,(s,c)=>{let a={};c==="auto"&&(a={marginLeft:"auto"}),typeof c=="number"&&(a={marginLeft:c===0?"0px":`calc(100% * ${c} / var(${b}) + var(${E("column")}) * ${c} / var(${b}))`}),s(t,a)}),t},Ke=({theme:e,ownerState:n})=>{if(!n.container)return{};const t={[O]:12};return $(e.breakpoints,n.columns,(s,c)=>{const a=c??12;s(t,{[O]:a,"> *":{[b]:a}})}),t},Xe=({theme:e,ownerState:n})=>{if(!n.container)return{};const t={};return $(e.breakpoints,n.rowSpacing,(s,c)=>{var o;const a=typeof c=="string"?c:(o=e.spacing)==null?void 0:o.call(e,c);s(t,{[G("row")]:a,"> *":{[E("row")]:a}})}),t},Ye=({theme:e,ownerState:n})=>{if(!n.container)return{};const t={};return $(e.breakpoints,n.columnSpacing,(s,c)=>{var o;const a=typeof c=="string"?c:(o=e.spacing)==null?void 0:o.call(e,c);s(t,{[G("column")]:a,"> *":{[E("column")]:a}})}),t},Ve=({theme:e,ownerState:n})=>{if(!n.container)return{};const t={};return $(e.breakpoints,n.direction,(s,c)=>{s(t,{flexDirection:c})}),t},qe=({ownerState:e})=>({minWidth:0,boxSizing:"border-box",...e.container&&{display:"flex",flexWrap:"wrap",...e.wrap&&e.wrap!=="wrap"&&{flexWrap:e.wrap},gap:`var(${G("row")}) var(${G("column")})`}}),He=e=>{const n=[];return Object.entries(e).forEach(([t,s])=>{s!==!1&&s!==void 0&&n.push(`grid-${t}-${String(s)}`)}),n},Je=(e,n="xs")=>{function t(s){return s===void 0?!1:typeof s=="string"&&!Number.isNaN(Number(s))||typeof s=="number"&&s>0}if(t(e))return[`spacing-${n}-${String(e)}`];if(typeof e=="object"&&!Array.isArray(e)){const s=[];return Object.entries(e).forEach(([c,a])=>{t(a)&&s.push(`spacing-${c}-${String(a)}`)}),s}return[]},Qe=e=>e===void 0?[]:typeof e=="object"?Object.entries(e).map(([n,t])=>`direction-${n}-${t}`):[`direction-xs-${String(e)}`],Ue=oe(),Ze=le("div",{name:"MuiGrid",slot:"Root",overridesResolver:(e,n)=>n.root});function es(e){return me({props:e,name:"MuiGrid",defaultTheme:Ue})}function ss(e={}){const{createStyledComponent:n=Ze,useThemeProps:t=es,useTheme:s=de,componentName:c="MuiGrid"}=e,a=(d,u)=>{const{container:j,direction:f,spacing:m,wrap:r,size:h}=d,M={root:["root",j&&"container",r!=="wrap"&&`wrap-xs-${String(r)}`,...Qe(f),...He(h),...j?Je(m,u.breakpoints.keys[0]):[]]};return he(M,N=>xe(c,N),{})};function o(d,u,j=()=>!0){const f={};return d===null||(Array.isArray(d)?d.forEach((m,r)=>{m!==null&&j(m)&&u.keys[r]&&(f[u.keys[r]]=m)}):typeof d=="object"?Object.keys(d).forEach(m=>{const r=d[m];r!=null&&j(r)&&(f[m]=r)}):f[u.keys[0]]=d),f}const l=n(Ke,Ye,Xe,Fe,Ve,qe,We),w=g.forwardRef(function(u,j){const f=s(),m=t(u),r=ue(m),{className:h,children:M,columns:N=12,container:z=!1,component:V="div",direction:q="row",wrap:H="wrap",size:J={},offset:Q={},spacing:P=0,rowSpacing:U=P,columnSpacing:Z=P,unstable_level:S=0,...ee}=r,se=o(J,f.breakpoints,y=>y!==!1),ne=o(Q,f.breakpoints),te=u.columns??(S?void 0:N),ae=u.spacing??(S?void 0:P),ie=u.rowSpacing??u.spacing??(S?void 0:U),ce=u.columnSpacing??u.spacing??(S?void 0:Z),L={...r,level:S,columns:te,container:z,direction:q,wrap:H,spacing:ae,rowSpacing:ie,columnSpacing:ce,size:se,offset:ne},re=a(L,f);return i.jsx(l,{ref:j,as:V,ownerState:L,className:ge(re.root,h),...ee,children:g.Children.map(M,y=>{var B;return g.isValidElement(y)&&fe(y,["Grid"])&&z&&y.props.container?g.cloneElement(y,{unstable_level:((B=y.props)==null?void 0:B.unstable_level)??S+1}):y})})});return w.muiName="Grid",w}const p=ss({createStyledComponent:je("div",{name:"MuiGrid2",slot:"Root",overridesResolver:(e,n)=>{const{ownerState:t}=e;return[n.root,t.container&&n.container]}}),componentName:"MuiGrid2",useThemeProps:e=>Me({props:e,name:"MuiGrid2"}),useTheme:v});function ns(e){return i.jsx(R,{sx:{position:"fixed",left:0,height:"55px",width:"100%",padding:1},children:i.jsx(F,{children:i.jsxs(p,{container:!0,spacing:2,sx:{height:"100%",alignItems:"center"},children:[i.jsx(p,{sx:{cursor:"pointer"},children:i.jsx(W,{component:ye,to:"/chat/all",children:i.jsx(I,{icon:pe})})}),i.jsx(p,{children:e.nameChat})]})})})}const ts=we.getSelectors(e=>e.messages.messages);function as(e){const n=g.useRef(!1),t=x(l=>l.user.id),s=k(),c=v(),a=e.itemMessage.user_id==t,o=e.itemMessage.viewed_at===null;return g.useEffect(()=>{e.itemMessage.viewed_at===null&&!n.current&&!a&&(s(Se(e.itemMessage.id)),n.current=!0)},[e.itemMessage.viewed_at,n.current]),i.jsxs(p,{container:!0,sx:{justifyContent:a?"end":"",alignItems:"flex-end",my:2},children:[o&&a&&i.jsx(I,{icon:D,color:c.palette.chat.pointNotRead,size:"xs"}),i.jsxs(R,{onContextMenu:a?e.onContextMenu:void 0,sx:{backgroundColor:a?"chat.selfMessageBackground":"chat.someoneMessageBackground",padding:1,mx:1,maxWidth:"50%",color:a?"chat.selfMessageTextColor":"chat.someoneMessageTextColor"},children:[i.jsx(be,{direction:"row",children:i.jsx(T,{children:e.itemMessage.message})}),i.jsx(T,{sx:{textAlign:"right",display:"block"},variant:"caption",children:Oe(e.itemMessage.created_at)})]}),o&&!a&&i.jsx(I,{icon:D,color:c.palette.chat.pointNotRead,size:"xs"})]})}function is(e){const n=k(),t=()=>{e.targetMessage&&n(Ce(e.targetMessage.id)),e.handleClose()},s=()=>{e.targetMessage&&n(K({id:e.targetMessage.id,message:e.targetMessage.message})),e.handleClose()};return i.jsxs($e,{open:e.contextMenu!==null,onClose:e.handleClose,anchorReference:"anchorPosition",anchorPosition:e.contextMenu!==null?{top:e.contextMenu.mouseY,left:e.contextMenu.mouseX}:void 0,children:[i.jsx(_,{onClick:s,children:"Редактировать"}),i.jsx(_,{onClick:t,children:"Удалить"})]})}function cs(e){const n=k(),t=g.useRef(!0),s=Ie(),c=g.useRef(null),[a,o]=g.useState(null),[l,w]=g.useState(null),d=x(ts.selectAll),u=x(r=>r.messages.loadingStatus)==="loading",j=x(r=>r.messages.endMessages);g.useEffect(()=>{var r;t.current&&d.length>0&&((r=c.current)==null||r.scrollIntoView({behavior:"auto"}),t.current=!1)},[d,t]),g.useEffect(()=>{var r;(r=c.current)==null||r.scrollIntoView({behavior:"auto"})},[(d[d.length-1]||{}).id]),X(()=>{const r=M=>{console.debug("create",M),n(ke(M.message))},h=M=>{console.debug("delete",M),n(Ge(M.message))};return e.chatId>0&&s!=null&&(console.debug(`listen channel: create-message-${e.chatId}. listen event: .create-message`),console.debug(`listen channel: change-message-${e.chatId}. listen event: .change-message`),console.debug(`listen channel: delete-message-${e.chatId}. listen event: .delete-message`),console.debug(`listen channel: watch-message-${e.chatId}. listen event: .watch-message`),s.channel(`create-message-${e.chatId}`).listen(".create-message",r),s.channel(`change-message-${e.chatId}`).listen(".change-message",r),s.channel(`delete-message-${e.chatId}`).listen(".delete-message",h),s.channel(`watch-message-${e.chatId}`).listen(".watch-message",r)),()=>{e.chatId>0&&s!=null&&(s.channel(`create-message-${e.chatId}`).stopListening(".create-message",r),s.channel(`change-message-${e.chatId}`).stopListening(".change-message",r),s.channel(`delete-message-${e.chatId}`).stopListening(".delete-message",h),s.channel(`watch-message-${e.chatId}`).stopListening(".watch-message",r))}},[e.chatId,s]),g.useEffect(()=>{const r=()=>{window.scrollY<1e3&&!u&&!j&&n(A({chat_id:e.chatId,last_id:d[0].id}))};return window.addEventListener("scroll",r),()=>{window.removeEventListener("scroll",r)}},[u,n,A,e.chatId,d]);const f=(r,h)=>{r.preventDefault(),o(a===null?{mouseX:r.clientX+2,mouseY:r.clientY-6}:null),w(h)},m=()=>{o(null)};return i.jsxs(C,{children:[d.map(r=>i.jsx(as,{itemMessage:r,onContextMenu:h=>f(h,r)},r.id)),i.jsx(is,{handleClose:m,contextMenu:a,targetMessage:l}),i.jsx("div",{ref:c})]})}function rs(e){const n=k(),t=x(l=>l.messages.editingMessage),s=x(l=>l.messages.loadingStatusEditing)==="loading",c=x(l=>l.messages.loadingStatusEditing)==="failed",a=()=>{n(Ae({chat_id:e.chatId,...t}))},o=l=>{l.key==="Enter"&&a()};return i.jsx(R,{sx:{position:"fixed",bottom:0,left:0,height:"80px",width:"100%"},children:i.jsxs(F,{children:[t.id&&i.jsx(T,{variant:"subtitle2",children:"Редактирование сообщения"}),i.jsxs(p,{container:!0,spacing:2,sx:{height:"100%",alignItems:"center"},children:[i.jsx(p,{size:10,children:i.jsx(Ee,{onKeyDown:o,fullWidth:!0,value:t.message,onChange:l=>n(K({...t,message:l.target.value}))})}),i.jsxs(p,{size:1,children:[s&&i.jsx(Y,{}),!s&&i.jsx(W,{onClick:a,children:i.jsx(I,{icon:Ne})})]}),i.jsx(p,{size:1,children:c&&i.jsx(Pe,{title:"Произошла ошибка во время отправки",children:i.jsx(I,{icon:Te,color:"red",size:"2x"})})})]})]})})}function ds(){const{chatId:e}=Re(),n=k(),t=x(o=>o.user.id),s=x(o=>o.chats.selectedChat),c=x(o=>o.messages.loadingStatus)==="loading",a=g.useMemo(()=>t==(s==null?void 0:s.user1.id)?s==null?void 0:s.user2.name:s==null?void 0:s.user1.name,[t,s==null?void 0:s.user1.name,s==null?void 0:s.user2.name])||"";return X(()=>(e&&(n(A({chat_id:Number(e)})),n(ze(Number(e)))),()=>{n(Le()),n(Be(null))}),[e]),De({label:a,depth:3}),i.jsxs(i.Fragment,{children:[c&&s===null&&i.jsx(_e,{open:!0,children:i.jsx(Y,{})}),!!e&&s!==null&&i.jsxs(C,{children:[i.jsx(ns,{nameChat:a}),i.jsx(C,{sx:{height:"55px"}}),i.jsx(cs,{chatId:Number(e)}),i.jsx(C,{sx:{height:"80px"}}),i.jsx(rs,{chatId:Number(e)})]}),!e&&i.jsx(C,{children:"Такой чат отсутствует!"})]})}export{ds as default};
